<mat-card class="p-3">
    <mat-card-header class="mb-2">
        <h1>Conseils alimentaires</h1>
    </mat-card-header>

    <mat-card-content>
        @if (isLoading) {
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <div class="text-muted small mt-2">Analyse et recherche d’alternatives…</div>
        }

        @if (!isLoading) {

        @if (items.length === 0) {
        <div class="text-muted">Aucun aliment sélectionné.</div>
        } @else {

        <div class="row g-3 mt-2">
            @for (item of items; track item.product.code) {
            @if(item.status !== "OK" || (item.product.nutrition_grades == "b" && item.alternatives.length === 0)){
            <div class="col-12">
                <mat-card class="p-3">
                    @if(item.alternatives.length==0){
                    <div class="d-flex gap-3 align-items-center flex-column flex-md-row">
                        <img [src]="item.product.image_url || 'assets/no-image.png'" alt=""
                            class="rounded flex-shrink-0 custom_image" />

                        <div class="flex-grow-1 overflow-hidden">
                            <div class="fw-semibold text-truncate">
                                {{ item.product.product_name || 'Nom inconnu' }}
                            </div>
                            <div class="text-muted small text-truncate">
                                {{ item.product.brand || 'Marque inconnue' }}
                            </div>

                            <div class="mt-2">
                                <span class="fw-semibold">Nutri-score :</span>
                                <span class="badge ms-2" [ngClass]="nutriClass(item.product.nutrition_grades)">
                                    {{ (item.product.nutrition_grades || 'N/A') | uppercase }}
                                </span>
                            </div>
                        </div>
                    </div>
                    }

                    <div class="mt-3">
                        @if (item.alternatives.length === 0) {
                        <div class="text-muted">
                            Aucune alternative mieux notée trouvée dans la même catégorie.
                        </div>
                        } @else {

                        <div class="border rounded p-3 d-flex flex-column flex-md-row align-items-center gap-3">

                            <div class="w-100 overflow-hidden">
                                <div class="text-muted small fw-semibold">Ton choix</div>
                                <div class="d-flex gap-3 align-items-center flex-column flex-md-row">
                                    <img [src]="item.product.image_url || 'assets/no-image.png'" alt=""
                                        class="rounded flex-shrink-0 custom_image" />

                                    <div class="flex-grow-1 overflow-hidden">
                                        <div class="fw-semibold text-truncate">
                                            {{ item.product.product_name || 'Nom inconnu' }}
                                        </div>
                                        <div class="text-muted small text-truncate">
                                            {{ item.product.brand || 'Marque inconnue' }}
                                        </div>

                                        <div class="mt-2">
                                            <span class="fw-semibold">Nutri-score :</span>
                                            <span class="badge ms-2"
                                                [ngClass]="nutriClass(item.product.nutrition_grades)">
                                                {{ (item.product.nutrition_grades || 'N/A') | uppercase }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex align-items-center justify-content-center px-2">
                                <mat-icon class="d-none d-md-inline">arrow_forward</mat-icon>
                            </div>

                            <div class="w-100 overflow-hidden">
                                <div class="text-muted small fw-semibold">Alternative</div>
                                <div class="d-flex gap-3 align-items-center flex-column flex-md-row">
                                    <img [src]="item.alternatives[0].image_url || 'assets/no-image.png'" alt=""
                                        class="rounded flex-shrink-0 custom_image" />

                                    <div class="flex-grow-1 overflow-hidden">
                                        <div class="fw-semibold text-truncate">
                                            {{ item.alternatives[0].product_name || 'Nom inconnu' }}
                                        </div>
                                        <div class="text-muted small text-truncate">
                                            {{ item.alternatives[0].brand || 'Marque inconnue' }}
                                        </div>

                                        <div class="mt-2">
                                            <span class="fw-semibold">Nutri-score :</span>
                                            <span class="badge ms-2"
                                                [ngClass]="nutriClass(item.alternatives[0].nutrition_grades)">
                                                {{ (item.alternatives[0].nutrition_grades || 'N/A') | uppercase }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @if (item.alternatives.length > 1) {
                        <div class="mt-3">
                            <div class="text-muted small mb-2">Autres alternatives :</div>

                            <div class="row g-2">
                                @for (a of item.alternatives.slice(1); track a.code) {
                                <div class="col-12 col-md-6 col-xl-4">
                                    <div class="border rounded p-2 d-flex gap-2 align-items-center">
                                        <img [src]="a.image_url || 'assets/no-image.png'" alt="{{a.product_name}}"
                                            class="rounded flex-shrink-0 custom_image" />

                                        <div class="flex-grow-1 overflow-hidden">
                                            <div class="fw-semibold text-truncate">{{ a.product_name }}</div>
                                            <div class="text-muted small text-truncate">{{ a.brand }}</div>
                                        </div>

                                        <span class="badge" [ngClass]="nutriClass(a.nutrition_grades)">
                                            {{ (a.nutrition_grades || 'N/A') | uppercase }}
                                        </span>
                                    </div>
                                </div>
                                }
                            </div>
                        </div>
                        }
                        }
                    </div>

                </mat-card>
            </div>
            }
            }
        </div>
        }
        }
    </mat-card-content>
</mat-card>