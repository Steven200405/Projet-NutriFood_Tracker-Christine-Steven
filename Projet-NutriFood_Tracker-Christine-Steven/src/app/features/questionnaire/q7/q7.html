<mat-card class="p-3 mt-3">
            <h4 class="fw-semibold">Sélectionnez une catégorie</h4>
            <mat-card-content>
                <mat-chip-listbox class="d-flex flex-wrap gap-2" aria-label="Catégories">
                    @for (catName of previousControl.value; track catName) {
                    <mat-chip-option [selected]="activeCategoryName === catName" (click)="setActiveCategory(catName)">
                        {{ catName }}
                    </mat-chip-option>
                    }
                </mat-chip-listbox>

                @if (!activeCategoryName) {
                <div class="text-muted mt-3">
                    Sélectionne une catégorie pour afficher des produits.
                </div>
                } @else {

                <div class="mt-3 fw-semibold">
                    Choisissez les produits les plus similaires à votre alimentation.
                </div>

                <!-- Chargement -->
                @if (isLoadingQ7) {
                <div class="mt-3">
                    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
                    <div class="text-muted small mt-2">
                        Chargement des produits… (si cela prend trop de temps, recliquez sur la catégorie)
                    </div>
                </div>
                } @else {

                <!-- Liste produits (Bootstrap grid) -->
                <div class="container-fluid px-0 mt-3">
                    <div class="row g-2 mt-2">
                        @for (p of searchResults; track p.code) {
                        <div class="col-12 col-md-6 col-xl-4">
                            <mat-card class="shadow-sm">
                                <mat-card-content class="d-flex align-items-center justify-content-between gap-2">
                                    <div class="d-flex align-items-center gap-2 overflow-hidden">
                                        <img [src]="p.image_url" alt="" class="rounded flex-shrink-0 img" />
                                        <div class="overflow-hidden">
                                            <div class="fw-semibold text-truncate">{{ p.product_name }}</div>
                                            <div class="text-muted small text-truncate">
                                                {{ p.brand ? p.brand : 'Marque inconnue' }}
                                            </div>
                                        </div>
                                    </div>

                                    <button mat-stroked-button type="button" (click)="addProductQ7(p)"
                                        [disabled]="isSelectedQ7(p.code) || isMaxReachedQ7()">
                                        Ajouter
                                    </button>
                                </mat-card-content>
                            </mat-card>
                        </div>
                        }
                    </div>
                </div>

                <mat-card class="mt-3">
                    <mat-card-header>
                        <mat-card-title class="fw-semibold">Sélections (max 3)</mat-card-title>
                    </mat-card-header>

                    <mat-card-content>
                        @if ((selectedProductsByCategory[activeCategoryName]?.length ?? 0) === 0) {
                        <div class="text-muted">Aucun produit sélectionné pour cette catégorie.</div>
                        } @else {
                        <div class="d-flex flex-column gap-2">
                            @for (s of selectedProductsByCategory[activeCategoryName]; track s.code) {
                            <div class="d-flex justify-content-between align-items-center border rounded p-2">
                                <div class="d-flex align-items-center gap-2 overflow-hidden">
                                    <img [src]="s.image_url" alt="" class="rounded flex-shrink-0 img" />
                                    <div class="overflow-hidden">
                                        <div class="fw-semibold text-truncate">{{ s.product_name }}</div>
                                        <div class="text-muted small text-truncate">
                                            {{ s.brand ? s.brand : 'Marque inconnue' }}
                                        </div>
                                    </div>
                                </div>

                                <button mat-button color="warn" type="button" (click)="removeProductQ7(s.code)">
                                    Retirer
                                </button>
                            </div>
                            }
                        </div>
                        }

                        @if (this.currentControl.value.length === 0) {
                        <div class="text-danger mt-2">
                            Sélectionnez au moins 1 produit pour valider le questionnaire.
                        </div>
                        }
                    </mat-card-content>
                </mat-card>

                <div class="alert alert-warning mt-3">
                    Si vous ne trouvez pas votre aliment, vous pouvez effectuer une recherche d'aliment en cliquant ici:
                    <button type="button" class="btn btn-outline-primary mt-2" (click)="goToFoodSearch()">
                        Aliment non trouvé
                    </button>
                </div>
                }
                }
            </mat-card-content>
        </mat-card>